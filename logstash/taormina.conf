input {
    udp {
        host => "0.0.0.0"
        port => "5514"
        type => "udp"
        tags => [ "pensando_flowlog" ]
    }
}
filter {
  dissect {
    mapping => { 'message' => '<%{syslog_priority}>%{syslog_version} %{gen_time} %{hostname} %{proc_name} %{proc_id} %{msg_id} %{sd} %{csv_message}'}
  }
  split {
    field => "csv_message"
  }
  dissect {
    mapping => { 'csv_message' => '%{timestamp},%{[session][state]},%{[session][action]},%{vrf},%{[source][ip]},%{[source][port]},%{[destination][ip]},%{[destination][port]},%{protocol},%{[session][id]},%{[security][policy_id]},%{[security][rule_id]},%{[security][rule_name]},%{[session][iflow_pkts]},%{[session][iflow_bytes]},%{[session][rflow_pkts]},%{[session][rflow_bytes]},%{[source][vlan]},%{[dsx][type]},%{[dsx][sw_ver]},%{[dsx][ser_num]},%{[dsx][device_name]},%{[dsx][unit_id]},%{version},%{[security][policy_name]},%{[security][policy_display_name]}'}
  }
  date
  {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }
  mutate {
    remove_field => [ "message" ]
    remove_field => [ "csv_message" ]
    remove_field => [ "timestamp" ]
    rename => { "type" => "syslog_proto" }

  }

  mutate {
        convert => {
          "[source][port]" => "integer"
          "[destination][port]" => "integer"
          "protocol" => "integer"
          "[session][iflow_pkts]" => "integer"
          "[session][iflow_bytes]" => "integer"
          "[session][rflow_pkts]" => "integer"
          "[session][rflow_bytes]" => "integer"
          "[source][vlan]" => "integer"
        }
      }

  ## add human readable protocol name
  if ([protocol] == 6) {
    mutate {
      add_field => {"[protocol_string]" => "tcp"}
    }
  }
  else if ([protocol] == 17) {
    mutate {
      add_field => {"[protocol_string]" => "udp"}
    }
  }
  else if ([protocol] == 1) {
    mutate {
      add_field => {"[protocol_string]" => "icmp"}
    }
  }
  else {
    mutate {
      add_field => {"[protocol_string]" => "other"}
    }
  }

}
output {
  elasticsearch {
        hosts    => [ 'elasticsearch' ]
        index => "pensando-fwlog-%{+YYYY.MM}"
    }

    #stdout { codec => rubydebug }
}
